<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MarrakFit – Votre coach calories & macros made in Morocco</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary-color: #C1272D; /* Rouge Marrakech */
            --primary-dark: #A02025;
            --primary-light: #E8B4B6;
            --secondary-color: #D4AF37; /* Or marocain */
            --secondary-dark: #B8941F;
            --secondary-light: #F4E4A9;
            --accent-color: #228B22; /* Vert palmier */
            --text-color: #2F2F2F;
            --text-light: #666;
            --background-color: #FDF6E3; /* Beige sable */
            --card-background: #FFFFFF;
            --border-color: #E0D6C3;
            --error-color: #C1272D;
            --success-color: #228B22;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }

        main {
            width: 100%;
            max-width: 900px;
            padding: 20px;
            background-color: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 2.5em;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .header h2 {
            font-size: 1em;
            color: var(--text-light);
            font-weight: 400;
        }

        .language-selector {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 5px;
        }

        .language-selector button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 5px 10px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }

        .language-selector button.active {
            background-color: var(--primary-dark);
        }

        .language-selector button:hover {
            background-color: var(--primary-dark);
        }

        .hidden {
            display: none !important;
        }

        .step-container, .results-container, .plan-container {
            transition: opacity 0.5s ease;
            opacity: 1;
        }

        .step-container.hidden, .results-container.hidden, .plan-container.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .step-indicators {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            position: relative;
        }

        .step-indicator {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--text-light);
            font-weight: bold;
            z-index: 2;
        }

        .step-indicator.active {
            background-color: var(--primary-color);
            color: white;
        }

        .step-indicator.completed {
            background-color: var(--accent-color);
            color: white;
        }

        .step-indicator:not(:last-child)::after {
            content: '';
            position: absolute;
            width: 100px;
            height: 2px;
            background-color: var(--border-color);
            left: calc(50% + 15px);
            top: 50%;
            transform: translateY(-50%);
            z-index: 1;
        }

        .step-content {
            text-align: center;
        }

        h3 {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        p {
            margin-bottom: 20px;
            color: var(--text-light);
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input[type="number"], .form-group input[type="date"], .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: #F8F8F8;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .radio-group {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .radio-label input[type="radio"] {
            display: none;
        }

        .radio-label input[type="radio"]:checked + span {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .radio-label span {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid transparent;
            transition: background-color 0.3s, color 0.3s;
        }

        .button-group {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        #nextBtn, #calculateBtn, #generatePlanBtn, #exportImageBtn, #printPlanBtn, #newPlanBtn, .history-item button, #backToHomeBtn, #savePlanBtn {
            background-color: var(--primary-color);
            color: white;
        }

        #prevBtn, #backToResultsBtn, #restartBtn {
            background-color: var(--border-color);
            color: var(--text-color);
        }

        .results-summary {
            text-align: center;
            margin-bottom: 20px;
        }

        .results-summary h3 {
            color: var(--primary-color);
            font-size: 2em;
        }

        .results-summary p {
            font-size: 1.2em;
            font-weight: bold;
        }

        .results-details {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .result-card {
            background-color: var(--secondary-light);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            flex: 1 1 200px;
            min-width: 150px;
        }

        .result-card h4 {
            color: var(--secondary-dark);
            margin-bottom: 5px;
        }

        .result-card p {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-color);
        }
        .plan-card {
            background-color: var(--background-color);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
        }

        .plan-card h4 {
            font-size: 1.2em;
            color: var(--primary-dark);
            margin-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 5px;
        }

        .plan-card p {
            margin-bottom: 5px;
            color: var(--text-color);
        }

        #nutritionPlanTitle {
            font-size: 1.5em;
            color: var(--primary-dark);
            text-align: center;
            margin-bottom: 20px;
        }
        
        #nutritionPlanDescription {
            text-align: center;
            margin-bottom: 20px;
            color: var(--text-light);
        }
        .plan-item {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
        }
        .plan-item h5 {
            font-size: 1.1em;
            color: var(--accent-color);
            margin-bottom: 5px;
        }
        .plan-item table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .plan-item th, .plan-item td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .plan-item th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        
        /* Home page styles */
        #homeSection {
            text-align: center;
        }

        #homeSection h3 {
            font-size: 2em;
            margin-bottom: 30px;
            color: var(--primary-color);
        }
        
        #newPlanBtn {
            font-size: 1.2em;
            padding: 15px 30px;
            margin-bottom: 40px;
            box-shadow: 0 4px 10px rgba(193, 39, 45, 0.3);
        }

        .history-section h4 {
            font-size: 1.5em;
            color: var(--secondary-dark);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
        }

        #historyList {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
            text-align: left;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f5f5f5;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: background-color 0.2s ease;
        }

        .history-item:hover {
            background-color: #ededed;
        }

        .history-item span {
            font-weight: bold;
            color: var(--text-color);
        }
        
        .history-item button {
            background-color: var(--accent-color);
            color: white;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .history-item button:hover {
            background-color: #1a711a;
        }
    </style>
</head>
<body>

<main>
    <div class="header">
        <h1>MarrakFit</h1>
        <h2>Votre coach calories & macros made in Morocco</h2>
        <div class="language-selector">
            <button onclick="setLanguage('fr')" id="lang-fr">FR</button>
            <button onclick="setLanguage('en')" id="lang-en">EN</button>
            <button onclick="setLanguage('ar')" id="lang-ar">AR</button>
        </div>
    </div>
    
    <!-- HOME PAGE -->
    <section id="homeSection">
        <h3>Bienvenue sur MarrakFit</h3>
        <button id="newPlanBtn">Nouveau plan</button>
        
        <div class="history-section">
            <h4>Historique</h4>
            <ul id="historyList">
                <!-- Saved plans will be inserted here by JavaScript -->
            </ul>
        </div>
    </section>

    <!-- MAIN APP SECTION -->
    <section id="appSection" class="hidden">
        <div class="step-indicators">
            <div class="step-indicator active">1</div>
            <div class="step-indicator">2</div>
            <div class="step-indicator">3</div>
        </div>

        <div id="step1" class="step-container">
            <div class="step-content">
                <h3>Informations personnelles</h3>
                <p>Veuillez fournir quelques informations de base pour le calcul.</p>
                <form id="step1Form">
                    <div class="form-group">
                        <label for="age">Âge</label>
                        <input type="number" id="age" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="gender">Sexe</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="gender" value="male" required>
                                <span>Homme</span>
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="gender" value="female" required>
                                <span>Femme</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="weight">Poids (kg)</label>
                        <input type="number" id="weight" step="0.1" min="20" required>
                    </div>
                    <div class="form-group">
                        <label for="height">Taille (cm)</label>
                        <input type="number" id="height" min="50" required>
                    </div>
                    <div class="button-group">
                        <button type="button" id="nextBtn">Suivant</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="step2" class="step-container hidden">
            <div class="step-content">
                <h3>Objectifs et activité</h3>
                <p>Décrivez votre objectif et votre niveau d'activité physique.</p>
                <form id="step2Form">
                    <div class="form-group">
                        <label for="goal">Objectif</label>
                        <select id="goal" required>
                            <option value="cut">Perte de poids</option>
                            <option value="maintain">Maintien</option>
                            <option value="bulk">Prise de masse</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="activity">Niveau d'activité</label>
                        <select id="activity" required>
                            <option value="sedentary">Sédentaire (peu ou pas d'exercice)</option>
                            <option value="lightly-active">Légèrement actif (exercice léger 1-3 jours/semaine)</option>
                            <option value="moderately-active">Modérément actif (exercice modéré 3-5 jours/semaine)</option>
                            <option value="very-active">Très actif (exercice intense 6-7 jours/semaine)</option>
                            <option value="extra-active">Extrêmement actif (exercice très intense + travail physique)</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button type="button" id="prevBtn">Précédent</button>
                        <button type="button" id="calculateBtn">Calculer</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="step3" class="results-container hidden">
            <div class="results-summary">
                <h3 id="dailyCalories"></h3>
                <p id="calorieDescription"></p>
            </div>
            <div class="results-details">
                <div class="result-card">
                    <h4>Protéines</h4>
                    <p id="proteinResult"></p>
                </div>
                <div class="result-card">
                    <h4>Lipides</h4>
                    <p id="fatResult"></p>
                </div>
                <div class="result-card">
                    <h4>Glucides</h4>
                    <p id="carbResult"></p>
                </div>
            </div>
            <div class="button-group" style="justify-content: center; gap: 10px; margin-top: 30px;">
                <button id="generatePlanBtn">Générer un plan de repas</button>
                <button id="restartBtn">Recommencer</button>
            </div>
        </div>

        <div id="planSection" class="plan-container hidden">
            <h3 id="nutritionPlanTitle"></h3>
            <p id="nutritionPlanDescription"></p>
            <div id="planContent">
                <!-- Le plan de repas sera inséré ici -->
            </div>
            <div class="button-group" style="justify-content: center; gap: 10px; margin-top: 30px;">
                <button id="backToResultsBtn">Précédent</button>
                <button id="exportImageBtn"><span>🖼️</span> Exporter en image</button>
                <button id="printPlanBtn"><span>🖨️</span> Imprimer le plan</button>
                <button id="savePlanBtn">Enregistrer</button>
                <button id="backToHomeBtn">Retour à l'accueil</button>
            </div>
        </div>
    </section>
</main>
    <script>
        // Translations object
        const translations = {
            fr: {
                title: 'Informations personnelles',
                description: 'Veuillez fournir quelques informations de base pour le calcul.',
                ageLabel: 'Âge',
                genderLabel: 'Sexe',
                maleLabel: 'Homme',
                femaleLabel: 'Femme',
                weightLabel: 'Poids (kg)',
                heightLabel: 'Taille (cm)',
                nextButton: 'Suivant',
                prevButton: 'Précédent',
                step2Title: 'Objectifs et activité',
                step2Description: 'Décrivez votre objectif et votre niveau d\'activité physique.',
                goalLabel: 'Objectif',
                goalCut: 'Perte de poids',
                goalMaintain: 'Maintien',
                goalBulk: 'Prise de masse',
                activityLabel: 'Niveau d\'activité',
                activitySedentary: 'Sédentaire (peu ou pas d\'exercice)',
                activityLight: 'Légèrement actif (exercice léger 1-3 jours/semaine)',
                activityModerate: 'Modérément actif (exercice modéré 3-5 jours/semaine)',
                activityVery: 'Très actif (exercice intense 6-7 jours/semaine)',
                activityExtra: 'Extrêmement actif (exercice très intense + travail physique)',
                calculateButton: 'Calculer',
                resultsTitle: 'S-estimation de vos besoins énergétiques quotidiens.',
                calorieDescription: 'Voici une estimation de vos besoins énergétiques quotidiens et une répartition de vos macronutriments en fonction de vos objectifs.',
                proteinLabel: 'Protéines',
                fatLabel: 'Lipides',
                carbLabel: 'Glucides',
                generatePlanButton: 'Générer un plan de repas',
                restartButton: 'Recommencer',
                nutritionPlanTitle: 'Plan de repas quotidien',
                planDescription: 'Ce plan est un exemple basé sur vos besoins. Ajustez selon vos préférences.',
                previousButton: 'Précédent',
                exportImageButton: 'Exporter en image',
                printButton: 'Imprimer le plan',
                mobileInfo: 'Pour la meilleure expérience, veuillez utiliser un ordinateur de bureau pour l\'impression et l\'exportation.',
                homeTitle: 'Bienvenue sur MarrakFit',
                newPlanBtn: 'Nouveau plan',
                historyTitle: 'Historique',
                loadBtn: 'Charger',
                backToHomeBtn: 'Retour à l\'accueil',
                savePlanBtn: 'Enregistrer',
                planSections: {
                    breakfast: 'Petit-déjeuner',
                    lunch: 'Déjeuner',
                    snack: 'Collation',
                    dinner: 'Dîner'
                },
                planTableHeaders: {
                    aliment: 'Aliment',
                    poids: 'Poids',
                    calories: 'Calories',
                    apports: 'Apports approximatifs'
                },
                total: 'Total'
            },
            en: {
                title: 'Personal Information',
                description: 'Please provide some basic information for the calculation.',
                ageLabel: 'Age',
                genderLabel: 'Gender',
                maleLabel: 'Male',
                femaleLabel: 'Female',
                weightLabel: 'Weight (kg)',
                heightLabel: 'Height (cm)',
                nextButton: 'Next',
                prevButton: 'Previous',
                step2Title: 'Goals & Activity',
                step2Description: 'Describe your goal and physical activity level.',
                goalLabel: 'Goal',
                goalCut: 'Weight Loss',
                goalMaintain: 'Maintenance',
                goalBulk: 'Weight Gain',
                activityLabel: 'Activity Level',
                activitySedentary: 'Sedentary (little to no exercise)',
                activityLight: 'Lightly active (light exercise 1-3 days/week)',
                activityModerate: 'Moderately active (moderate exercise 3-5 days/week)',
                activityVery: 'Very active (intense exercise 6-7 days/week)',
                activityExtra: 'Extra active (very intense exercise + physical job)',
                calculateButton: 'Calculate',
                resultsTitle: 'Estimated Daily Calories',
                calorieDescription: 'Here is an estimate of your daily energy needs and a breakdown of your macronutrients based on your goals.',
                proteinLabel: 'Protein',
                fatLabel: 'Fat',
                carbLabel: 'Carbohydrates',
                generatePlanButton: 'Generate a meal plan',
                restartButton: 'Restart',
                nutritionPlanTitle: 'Daily Meal Plan',
                planDescription: 'This plan is an example based on your needs. Adjust according to your preferences.',
                previousButton: 'Previous',
                exportImageButton: 'Export as Image',
                printButton: 'Print Plan',
                mobileInfo: 'For the best experience, please use a desktop computer for printing and exporting.',
                homeTitle: 'Welcome to MarrakFit',
                newPlanBtn: 'New Plan',
                historyTitle: 'History',
                loadBtn: 'Load',
                backToHomeBtn: 'Back to Home',
                savePlanBtn: 'Save',
                planSections: {
                    breakfast: 'Breakfast',
                    lunch: 'Lunch',
                    snack: 'Snack',
                    dinner: 'Dinner'
                },
                planTableHeaders: {
                    aliment: 'Food',
                    poids: 'Weight',
                    calories: 'Calories',
                    apports: 'Approximate contribution'
                },
                total: 'Total'
            },
            ar: {
                title: 'المعلومات الشخصية',
                description: 'يرجى تقديم بعض المعلومات الأساسية للحساب.',
                ageLabel: 'العمر',
                genderLabel: 'الجنس',
                maleLabel: 'ذكر',
                femaleLabel: 'أنثى',
                weightLabel: 'الوزن (كجم)',
                heightLabel: 'الطول (سم)',
                nextButton: 'التالي',
                prevButton: 'السابق',
                step2Title: 'الأهداف والنشاط',
                step2Description: 'صف هدفك ومستوى نشاطك البدني.',
                goalLabel: 'الهدف',
                goalCut: 'فقدان الوزن',
                goalMaintain: 'المحافظة على الوزن',
                goalBulk: 'زيادة الوزن',
                activityLabel: 'مستوى النشاط',
                activitySedentary: 'خامل (قليل من التمارين أو لا شيء)',
                activityLight: 'نشط قليلاً (تمارين خفيفة 1-3 أيام/أسبوع)',
                activityModerate: 'نشط معتدل (تمارين معتدلة 3-5 أيام/أسبوع)',
                activityVery: 'نشط جداً (تمارين مكثفة 6-7 أيام/أسبوع)',
                activityExtra: 'نشط للغاية (تمارين مكثفة جداً + عمل بدني)',
                calculateButton: 'احسب',
                resultsTitle: 'السعرات الحرارية اليومية المقدرة',
                calorieDescription: 'هنا تقدير لاحتياجاتك اليومية من الطاقة وتوزيع المغذيات الكبيرة بناءً على أهدافك.',
                proteinLabel: 'البروتينات',
                fatLabel: 'الدهون',
                carbLabel: 'الكربوهيدرات',
                generatePlanButton: 'إنشاء خطة وجبات',
                restartButton: 'ابدأ من جديد',
                nutritionPlanTitle: 'خطة وجبات يومية',
                planDescription: 'هذه الخطة هي مثال بناءً على احتياجاتك. قم بالتعديل حسب تفضيلاتك.',
                previousButton: 'السابق',
                exportImageButton: 'تصدير كصورة',
                printButton: 'طباعة الخطة',
                mobileInfo: 'لأفضل تجربة، يرجى استخدام جهاز كمبيوتر مكتبي للطباعة والتصدير.',
                homeTitle: 'مرحبا بكم في MarrakFit',
                newPlanBtn: 'خطة جديدة',
                historyTitle: 'التاريخ',
                loadBtn: 'تحميل',
                backToHomeBtn: 'العودة إلى الصفحة الرئيسية',
                savePlanBtn: 'حفظ',
                planSections: {
                    breakfast: 'وجبة الإفطار',
                    lunch: 'وجبة الغداء',
                    snack: 'وجبة خفيفة',
                    dinner: 'وجبة العشاء'
                },
                planTableHeaders: {
                    aliment: 'طعام',
                    poids: 'وزن',
                    calories: 'سعرات',
                    apports: 'مساهمات تقريبية'
                },
                total: 'المجموع'
            }
        };

        let currentStep = 1;
        let userData = {};
        let finalResults = {};
        let lang = 'fr';
        
        // Data for meal plan scaling
        const mealPlanData = {
            breakfast: {
                totalCals: 460,
                foods: [
                    { name: 'Œufs', calsPerGram: 1.4, proteinPerGram: 0.12, fatPerGram: 0.09, carbPerGram: 0, initialWeight: 128 },
                    { name: 'Pain complet', calsPerGram: 2.58, proteinPerGram: 0.09, fatPerGram: 0.05, carbPerGram: 0.49, initialWeight: 43 },
                    { name: 'Avocat', calsPerGram: 1.6, proteinPerGram: 0.02, fatPerGram: 0.15, carbPerGram: 0.09, initialWeight: 43 },
                    { name: 'Fruit', calsPerGram: 0.8, proteinPerGram: 0, fatPerGram: 0, carbPerGram: 0.2, initialWeight: 85 },
                    { name: 'Huile d\'olive', calsPerGram: 8.5, proteinPerGram: 0, fatPerGram: 0.96, carbPerGram: 0, initialWeight: 4 }
                ]
            },
            lunch: {
                totalCals: 571,
                foods: [
                    { name: 'Poulet grillé', calsPerGram: 1.84, proteinPerGram: 0.22, fatPerGram: 0.09, carbPerGram: 0, initialWeight: 153 },
                    { name: 'Riz complet cuit', calsPerGram: 1.25, proteinPerGram: 0.03, fatPerGram: 0, carbPerGram: 0.29, initialWeight: 102 },
                    { name: 'Légumes vapeur', calsPerGram: 0.35, proteinPerGram: 0, fatPerGram: 0, carbPerGram: 0.07, initialWeight: 171 },
                    { name: 'Huile d\'olive', calsPerGram: 8.5, proteinPerGram: 0, fatPerGram: 0.96, carbPerGram: 0, initialWeight: 13 }
                ]
            },
            snack: {
                totalCals: 170,
                foods: [
                    { name: 'Fruit', calsPerGram: 0.8, proteinPerGram: 0, fatPerGram: 0, carbPerGram: 0.2, initialWeight: 85 },
                    { name: 'Noix', calsPerGram: 6.0, proteinPerGram: 0.24, fatPerGram: 0.51, carbPerGram: 0.12, initialWeight: 17 }
                ]
            },
            dinner: {
                totalCals: 481,
                foods: [
                    { name: 'Poulet grillé', calsPerGram: 1.84, proteinPerGram: 0.22, fatPerGram: 0.09, carbPerGram: 0, initialWeight: 128 },
                    { name: 'Riz complet cuit', calsPerGram: 1.25, proteinPerGram: 0.03, fatPerGram: 0, carbPerGram: 0.29, initialWeight: 85 },
                    { name: 'Salade verte', calsPerGram: 0.27, proteinPerGram: 0.01, fatPerGram: 0, carbPerGram: 0.05, initialWeight: 128 },
                    { name: 'Huile d\'olive', calsPerGram: 8.5, proteinPerGram: 0, fatPerGram: 0.96, carbPerGram: 0, initialWeight: 13 }
                ]
            }
        };

        // UI elements
        const homeSection = document.getElementById('homeSection');
        const appSection = document.getElementById('appSection');
        const newPlanBtn = document.getElementById('newPlanBtn');
        const historyList = document.getElementById('historyList');
        const savePlanBtn = document.getElementById('savePlanBtn');

        const step1Form = document.getElementById('step1Form');
        const nextBtn = document.getElementById('nextBtn');
        const prevBtn = document.getElementById('prevBtn');
        const calculateBtn = document.getElementById('calculateBtn');
        const generatePlanBtn = document.getElementById('generatePlanBtn');
        const restartBtn = document.getElementById('restartBtn');
        const backToHomeBtn = document.getElementById('backToHomeBtn');
        const backToResultsBtn = document.getElementById('backToResultsBtn');
        const printPlanBtn = document.getElementById('printPlanBtn');
        const exportImageBtn = document.getElementById('exportImageBtn');

        // Functions to show/hide pages
        function showPage(pageId) {
            homeSection.classList.add('hidden');
            appSection.classList.add('hidden');
            
            if (pageId === 'homeSection') {
                homeSection.classList.remove('hidden');
                loadHistory();
            } else if (pageId === 'appSection') {
                appSection.classList.remove('hidden');
            }
        }

        // Update step indicators
        function updateSteps(step) {
            document.querySelectorAll('.step-indicator').forEach((indicator, index) => {
                indicator.classList.remove('active', 'completed');
                if (index < step - 1) {
                    indicator.classList.add('completed');
                } else if (index === step - 1) {
                    indicator.classList.add('active');
                }
            });

            document.querySelectorAll('.step-container, .results-container, .plan-container').forEach(section => {
                section.classList.add('hidden');
            });
            // Show the correct section based on the step
            if (step === 1) {
                document.getElementById('step1').classList.remove('hidden');
            } else if (step === 2) {
                document.getElementById('step2').classList.remove('hidden');
            } else if (step === 3) {
                document.getElementById('step3').classList.remove('hidden');
            } else if (step === 4) {
                 document.getElementById('planSection').classList.remove('hidden');
            }
        }

        // Language management
        function setLanguage(newLang) {
            lang = newLang;
            document.querySelectorAll('.language-selector button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`lang-${newLang}`).classList.add('active');
            document.documentElement.lang = newLang;
            
            // Update all texts
            document.querySelector('#step1 h3').textContent = translations[lang].title;
            document.querySelector('#step1 p').textContent = translations[lang].description;
            document.querySelector('label[for="age"]').textContent = translations[lang].ageLabel;
            document.querySelector('label[for="gender"]').textContent = translations[lang].genderLabel;
            document.querySelector('label[for="weight"]').textContent = translations[lang].weightLabel;
            document.querySelector('label[for="height"]').textContent = translations[lang].heightLabel;
            document.querySelector('#newPlanBtn').textContent = translations[lang].newPlanBtn;
            document.querySelector('#homeSection h3').textContent = translations[lang].homeTitle;
            document.querySelector('.history-section h4').textContent = translations[lang].historyTitle;
            document.querySelector('#nextBtn').textContent = translations[lang].nextButton;
            document.querySelector('#step2 h3').textContent = translations[lang].step2Title;
            document.querySelector('#step2 p').textContent = translations[lang].step2Description;
            document.querySelector('label[for="goal"]').textContent = translations[lang].goalLabel;
            document.querySelector('label[for="activity"]').textContent = translations[lang].activityLabel;
            document.querySelector('#prevBtn').textContent = translations[lang].prevButton;
            document.querySelector('#calculateBtn').textContent = translations[lang].calculateButton;
            document.querySelector('#generatePlanBtn').textContent = translations[lang].generatePlanButton;
            document.querySelector('#restartBtn').textContent = translations[lang].restartButton;
            document.querySelector('#backToResultsBtn').textContent = translations[lang].previousButton;
            document.querySelector('#exportImageBtn').innerHTML = `<span>🖼️</span> ${translations[lang].exportImageButton}`;
            document.querySelector('#printPlanBtn').innerHTML = `<span>🖨️</span> ${translations[lang].printButton}`;
            document.querySelector('#savePlanBtn').textContent = translations[lang].savePlanBtn;
            document.querySelector('#backToHomeBtn').textContent = translations[lang].backToHomeBtn;
            
            // Gender labels
            const genderLabels = document.querySelectorAll('.radio-label span');
            genderLabels[0].textContent = translations[lang].maleLabel;
            genderLabels[1].textContent = translations[lang].femaleLabel;

            // Goal options
            document.querySelector('#goal option[value="cut"]').textContent = translations[lang].goalCut;
            document.querySelector('#goal option[value="maintain"]').textContent = translations[lang].goalMaintain;
            document.querySelector('#goal option[value="bulk"]').textContent = translations[lang].goalBulk;

            // Activity options
            document.querySelector('#activity option[value="sedentary"]').textContent = translations[lang].activitySedentary;
            document.querySelector('#activity option[value="lightly-active"]').textContent = translations[lang].activityLight;
            document.querySelector('#activity option[value="moderately-active"]').textContent = translations[lang].activityModerate;
            document.querySelector('#activity option[value="very-active"]').textContent = translations[lang].activityVery;
            document.querySelector('#activity option[value="extra-active"]').textContent = translations[lang].activityExtra;
            
            // Result labels
            document.querySelector('#dailyCalories').textContent = finalResults.tdee ? `${finalResults.tdee} kcal` : '';
            document.querySelector('#calorieDescription').textContent = translations[lang].calorieDescription;
            document.querySelector('#proteinResult').textContent = finalResults.protein ? `${finalResults.protein} g` : '';
            document.querySelector('#fatResult').textContent = finalResults.fat ? `${finalResults.fat} g` : '';
            document.querySelector('#carbResult').textContent = finalResults.carb ? `${finalResults.carb} g` : '';

            // Adjust text direction for Arabic
            if (lang === 'ar') {
                document.body.style.direction = 'rtl';
                document.body.style.textAlign = 'right';
            } else {
                document.body.style.direction = 'ltr';
                document.body.style.textAlign = 'left';
            }
            
            // Re-generate lists and results if needed to translate them
            if (!homeSection.classList.contains('hidden')) {
                loadHistory();
            }
        }

        // NAVIGATION
        nextBtn.addEventListener('click', () => {
            if (step1Form.checkValidity()) {
                const age = document.getElementById('age').value;
                const gender = document.querySelector('input[name="gender"]:checked').value;
                const weight = document.getElementById('weight').value;
                const height = document.getElementById('height').value;
                
                userData = { age, gender, weight, height };
                currentStep = 2;
                updateSteps(currentStep);
            } else {
                step1Form.reportValidity();
            }
        });

        prevBtn.addEventListener('click', () => {
            currentStep = 1;
            updateSteps(currentStep);
        });
        
        // Calculation
        calculateBtn.addEventListener('click', () => {
            const goal = document.getElementById('goal').value;
            const activity = document.getElementById('activity').value;

            userData = { ...userData, goal, activity };
            calculateResults();
            currentStep = 3;
            updateSteps(currentStep);
        });

        function calculateResults() {
            const { age, gender, weight, height, goal, activity } = userData;
            let bmr;

            if (gender === 'male') {
                bmr = 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                bmr = 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }

            const activityMultipliers = {
                'sedentary': 1.2,
                'lightly-active': 1.375,
                'moderately-active': 1.55,
                'very-active': 1.725,
                'extra-active': 1.9
            };
            
            let tdee = bmr * activityMultipliers[activity];
            
            if (goal === 'cut') {
                tdee -= 500;
            } else if (goal === 'bulk') {
                tdee += 500;
            }
            
            // Macro calculation
            const proteinGrams = weight * (goal === 'bulk' ? 2.2 : 1.8);
            const proteinCals = proteinGrams * 4;
            
            const fatGrams = tdee * 0.25 / 9;
            const fatCals = fatGrams * 9;
            
            const carbCals = tdee - proteinCals - fatCals;
            const carbGrams = carbCals / 4;
            
            // Display results
            document.getElementById('dailyCalories').textContent = `${Math.round(tdee)} kcal`;
            document.getElementById('calorieDescription').textContent = translations[lang].calorieDescription;
            document.getElementById('proteinResult').textContent = `${Math.round(proteinGrams)} g`;
            document.getElementById('fatResult').textContent = `${Math.round(fatGrams)} g`;
            document.getElementById('carbResult').textContent = `${Math.round(carbGrams)} g`;
            
            finalResults = {
                tdee: Math.round(tdee),
                protein: Math.round(proteinGrams),
                fat: Math.round(fatGrams),
                carb: Math.round(carbGrams)
            };
        }

        // Generate and display meal plan
        generatePlanBtn.addEventListener('click', () => {
            generateNutritionPlan();
            currentStep = 4;
            updateSteps(currentStep);
        });

        function generateNutritionPlan() {
            const { tdee, protein, fat, carb } = finalResults;
            const planContent = document.getElementById('planContent');
            planContent.innerHTML = '';
            
            document.getElementById('nutritionPlanTitle').textContent = `${translations[lang].nutritionPlanTitle} - ${tdee} kcal`;
            document.getElementById('nutritionPlanDescription').textContent = translations[lang].planDescription;

            // Recalculate daily totals to distribute them to meals
            const totalProteinCals = protein * 4;
            const totalFatCals = fat * 9;
            const totalCarbCals = carb * 4;
            
            // Generate meal plan with new calculated macros
            const mealPlanRatios = {
                breakfast: 0.27,
                lunch: 0.34,
                snack: 0.10,
                dinner: 0.29
            };
            
            // Loop through each meal and generate its content
            for (const mealKey in mealPlanData) {
                const meal = mealPlanData[mealKey];
                
                // Calculate calories for this meal based on user's TDEE
                const mealCals = Math.round(tdee * mealPlanRatios[mealKey]);
                
                // Scale factor to adjust food quantities based on calorie needs
                const scaleFactor = mealCals / meal.totalCals;
                
                let mealProteinTotal = 0;
                let mealFatTotal = 0;
                let mealCarbTotal = 0;

                const card = document.createElement('div');
                card.className = 'plan-item';
                
                // Meal title
                let mealTitle;
                if (mealKey === 'snack' && Object.keys(mealPlanData).filter(key => key.includes('snack')).length > 1) {
                    // Si on a plusieurs snacks (ex: snack1, snack2)
                    mealTitle = translations[lang].planSections.snack + ` - ${Object.keys(mealPlanData).indexOf(mealKey) === 2 ? 'matin' : 'après-midi'}`;
                } else {
                    mealTitle = translations[lang].planSections[mealKey];
                }
                
                let tableHtml = `
                    <h5>${mealTitle}</h5>
                    <table>
                        <thead>
                            <tr>
                                <th>${translations[lang].planTableHeaders.aliment}</th>
                                <th>${translations[lang].planTableHeaders.poids}</th>
                                <th>${translations[lang].planTableHeaders.calories}</th>
                                <th>${translations[lang].planTableHeaders.apports}</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Loop through foods for this meal
                meal.foods.forEach(food => {
                    // Scale food quantity
                    const scaledWeight = Math.round(food.initialWeight * scaleFactor);
                    
                    // Calculate macros for scaled quantity
                    const foodProtein = Math.round(food.proteinPerGram * scaledWeight);
                    const foodFat = Math.round(food.fatPerGram * scaledWeight);
                    const foodCarb = Math.round(food.carbPerGram * scaledWeight);
                    const foodCals = Math.round(food.calsPerGram * scaledWeight);

                    // Add to meal totals
                    mealProteinTotal += foodProtein;
                    mealFatTotal += foodFat;
                    mealCarbTotal += foodCarb;
                    
                    let apportString = '';
                    if (foodProtein > 0) apportString += `Protéines ${foodProtein}g, `;
                    if (foodFat > 0) apportString += `Lipides ${foodFat}g, `;
                    if (foodCarb > 0) apportString += `Glucides ${foodCarb}g, `;
                    apportString = apportString.slice(0, -2); // remove last comma and space
                    
                    tableHtml += `
                        <tr>
                            <td>${food.name}</td>
                            <td>${scaledWeight}g</td>
                            <td>${foodCals} kcal</td>
                            <td>${apportString}</td>
                        </tr>
                    `;
                });
                
                // Add meal total row
                tableHtml += `
                    <tr style="font-weight: bold;">
                        <td>${translations[lang].total}</td>
                        <td></td>
                        <td>${mealCals} kcal</td>
                        <td>
                            Protéines ${mealProteinTotal}g, 
                            Lipides ${mealFatTotal}g, 
                            Glucides ${mealCarbTotal}g
                        </td>
                    </tr>
                `;
                
                tableHtml += `
                        </tbody>
                    </table>
                `;
                
                card.innerHTML = tableHtml;
                planContent.appendChild(card);
            }
        }

        // Return to results page
        backToResultsBtn.addEventListener('click', () => {
            currentStep = 3;
            updateSteps(currentStep);
        });

        // Restart from the beginning (from results page)
        restartBtn.addEventListener('click', () => {
            currentStep = 1;
            updateSteps(currentStep);
            document.getElementById('step1Form').reset();
            document.getElementById('step2Form').reset();
        });

        // Return to home page
        backToHomeBtn.addEventListener('click', () => {
            showPage('homeSection');
        });
        
        // Save plan button
        savePlanBtn.addEventListener('click', () => {
            savePlan();
            backToHomeBtn.click(); // Redirect to home page
        });


        // Export and print functions
        exportImageBtn.addEventListener('click', () => {
            html2canvas(document.getElementById('planSection'), {
                scale: 2,
                allowTaint: true,
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.href = canvas.toDataURL('image/png');
                link.download = `MarrakFit_Plan_${new Date().toISOString().slice(0, 10)}.png`;
                link.click();
            });
        });

        printPlanBtn.addEventListener('click', () => {
            const printContent = document.getElementById('planSection').cloneNode(true);
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>MarrakFit Plan de Repas</title>');
            printWindow.document.write('<style>');
            printWindow.document.write('body { font-family: \'Segoe UI\', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; }');
            printWindow.document.write('.plan-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 8px; }');
            printWindow.document.write('.plan-item table { width: 100%; border-collapse: collapse; margin-top: 10px; }');
            printWindow.document.write('.plan-item th, .plan-item td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }');
            printWindow.document.write('.plan-item th { background-color: #f2f2f2; font-weight: bold; }');
            printWindow.document.write('</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent.innerHTML);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        });

        // Plan history management
        function savePlan() {
            const plans = getPlans();
            const now = new Date();
            const id = now.getTime();
            
            const planToSave = {
                id: id,
                title: `Plan du ${now.toLocaleDateString(lang, { day: '2-digit', month: '2-digit', year: 'numeric' })} à ${now.toLocaleTimeString(lang, { hour: '2-digit', minute: '2-digit' })}`,
                data: {
                    userData: userData,
                    results: finalResults,
                }
            };

            plans.unshift(planToSave);
            localStorage.setItem('marrakfit_plans', JSON.stringify(plans));
            loadHistory();
        }

        function getPlans() {
            const plans = localStorage.getItem('marrakfit_plans');
            return plans ? JSON.parse(plans) : [];
        }

        function loadHistory() {
            const plans = getPlans();
            historyList.innerHTML = '';
            
            if (plans.length === 0) {
                historyList.innerHTML = `<li style="text-align: center; color: var(--text-light);">Aucun plan sauvegardé.</li>`;
                return;
            }

            plans.forEach(plan => {
                const li = document.createElement('li');
                li.className = 'history-item';
                li.innerHTML = `
                    <span>${plan.title}</span>
                    <button data-id="${plan.id}">${translations[lang].loadBtn}</button>
                `;
                li.querySelector('button').addEventListener('click', () => {
                    loadPlanFromHistory(plan.id);
                });
                historyList.appendChild(li);
            });
        }
        
        function loadPlanFromHistory(id) {
            const plans = getPlans();
            const plan = plans.find(p => p.id == id);
            
            if (plan) {
                userData = plan.data.userData;
                finalResults = plan.data.results;
                
                showPage('appSection');
                document.getElementById('step3').classList.remove('hidden');
                document.getElementById('planSection').classList.add('hidden');
                
                document.getElementById('dailyCalories').textContent = `${finalResults.tdee} kcal`;
                document.getElementById('calorieDescription').textContent = translations[lang].calorieDescription;
                document.getElementById('proteinResult').textContent = `${finalResults.protein} g`;
                document.getElementById('fatResult').textContent = `${finalResults.fat} g`;
                document.getElementById('carbResult').textContent = `${finalResults.carb} g`;
                
                updateSteps(3);
                
            } else {
                console.error("Plan not found.");
            }
        }
        
        // Initial setup
        document.addEventListener('DOMContentLoaded', () => {
            setLanguage('fr');
            showPage('homeSection');
        });

        // Event listener for "New Plan" button
        newPlanBtn.addEventListener('click', () => {
            showPage('appSection');
            currentStep = 1;
            updateSteps(1);
            document.getElementById('step1Form').reset();
            document.getElementById('step2Form').reset();
        });
    </script>
</body>
</html>
